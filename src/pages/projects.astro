---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import ProjectCard from "../components/projects/ProjectCard.astro";
import { allProjectsData } from "../data/projectsData";

const projects = allProjectsData;

function slugify(text: string): string {
  return text
    .toString()
    .toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^\w-]+/g, "")
    .replace(/--+/g, "-")
    .replace(/^-+/, "")
    .replace(/-+$/, "");
}
---

<SubPageLayout title="Proyectos">
  <p class="page-intro">
    Estos son algunos de los proyectos más representativos de mi trabajo con EDHUCO. 
    Aquí exploro soluciones creativas a través del diseño sonoro, tecnologías emergentes y estrategias participativas. 
    Para más detalles técnicos, puedes visitar los repositorios vinculados.
  </p>
  <div class="projects-grid">
    {
      projects.map((project) => {
        const slug = slugify(project.title);
        return (
          <ProjectCard
            id={slug}
            title={project.title}
            timeframe={project.timeframe}
            imageSrc={project.imageSrc}
            imageAlt={project.imageAlt}
            
            projectUrl={project.projectUrl}
            
            techStack={project.techStack}
          >
            <div set:html={project.description} />
          </ProjectCard>
        );
      })
    }
  </div>
</SubPageLayout>

<script>
  import { gsap } from "gsap";
  import { ScrollToPlugin } from "gsap/ScrollToPlugin";

  gsap.registerPlugin(ScrollToPlugin);

  function smoothScrollToTarget() {
    const params = new URLSearchParams(window.location.search);
    const targetId = params.get("scrollTo");
    if (targetId) {
      setTimeout(() => {
        const targetElement = document.getElementById(targetId);
        const pageWrapperElement = document.querySelector(".page-wrapper");

        if (targetElement && pageWrapperElement) {
          const finalScrollPosition = targetElement.offsetTop;
          gsap.to(pageWrapperElement, {
            duration: 1,
            scrollTo: { y: finalScrollPosition },
            ease: "power4.out",
          });

          try {
            history.replaceState(null, "", window.location.pathname);
          } catch (e) {
            console.error("URL cleanup failed:", e);
          }
        }
      }, 100);
    }
  }

  document.addEventListener("astro:page-load", smoothScrollToTarget);
</script>

<style>
  .page-intro {
    font-size: 1.2rem;
    color: var(--text-muted);
    margin-bottom: 3rem;
    max-width: 70ch;
  }
  .projects-grid {
    column-count: 1;
    column-gap: 3rem;
    gap: 3rem;
  }

  @media (min-width: 1024px) {
    .projects-grid {
      column-count: 2;
    }
  }

  .projects-grid > :global(.project-card) {
    break-inside: avoid;
  }
</style>
